<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life Tracker</title>
    
    <!-- üõ°Ô∏è SECURITY: Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' 'unsafe-eval' 
            https://cdnjs.cloudflare.com 
            https://cdn.tailwindcss.com 
            https://cdn.jsdelivr.net;
        style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com;
        connect-src 'self' https://spenpcmolydeumtskdqj.supabase.co https://*.supabase.co;
        img-src 'self' data: blob: https://spenpcmolydeumtskdqj.supabase.co;
        font-src 'self';
        frame-ancestors 'none';
        base-uri 'self';
        form-action 'self';
    ">
    
    <!-- üõ°Ô∏è SECURITY: Additional security headers via meta tags -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;
        
        // ===========================================
        // üõ°Ô∏è SECURITY UTILITIES
        // ===========================================
        
        const SecurityUtils = {
            // üõ°Ô∏è Generate cryptographically secure UUID v4
            generateUUID: () => {
                if (crypto && crypto.randomUUID) {
                    return crypto.randomUUID();
                }
                // Fallback for older browsers
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, (c) => {
                    const r = crypto.getRandomValues(new Uint8Array(1))[0] % 16;
                    const v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            },
            
            // üõ°Ô∏è Sanitize string input - prevent XSS
            sanitizeString: (input, maxLength = 1000) => {
                if (typeof input !== 'string') return '';
                return input
                    .slice(0, maxLength)
                    .replace(/[<>]/g, '') // Remove angle brackets
                    .trim();
            },
            
            // üõ°Ô∏è Sanitize for display - HTML encode
            escapeHtml: (str) => {
                if (typeof str !== 'string') return '';
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            },
            
            // üõ°Ô∏è Validate email format
            isValidEmail: (email) => {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email) && !email.includes('..') && !email.includes('\\');
            },
            
            // üõ°Ô∏è Validate date format (YYYY-MM-DD)
            isValidDate: (dateStr) => {
                if (!/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return false;
                const date = new Date(dateStr);
                return date instanceof Date && !isNaN(date);
            },
            
            // üõ°Ô∏è Validate positive number
            isValidPositiveNumber: (num) => {
                const parsed = parseFloat(num);
                return !isNaN(parsed) && parsed >= 0 && parsed < 10000000;
            },
            
            // üõ°Ô∏è Validate year (reasonable range)
            isValidYear: (year) => {
                const parsed = parseInt(year);
                return !isNaN(parsed) && parsed >= 1900 && parsed <= new Date().getFullYear() + 2;
            },
            
            // üõ°Ô∏è Validate mileage
            isValidMileage: (mileage) => {
                const parsed = parseInt(mileage);
                return !isNaN(parsed) && parsed >= 0 && parsed < 2000000;
            },
            
            // üõ°Ô∏è File validation constants
            ALLOWED_IMAGE_TYPES: ['image/jpeg', 'image/png', 'image/gif', 'image/webp'],
            ALLOWED_DOC_TYPES: ['application/pdf'],
            MAX_FILE_SIZE: 10 * 1024 * 1024, // 10MB
            
            // üõ°Ô∏è Magic bytes for file type verification
            MAGIC_BYTES: {
                'image/jpeg': [[0xFF, 0xD8, 0xFF]],
                'image/png': [[0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A]],
                'image/gif': [[0x47, 0x49, 0x46, 0x38]],
                'image/webp': [[0x52, 0x49, 0x46, 0x46]], // RIFF header
                'application/pdf': [[0x25, 0x50, 0x44, 0x46]] // %PDF
            },
            
            // üõ°Ô∏è Verify file magic bytes
            verifyFileMagicBytes: async (file) => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const arr = new Uint8Array(e.target.result).slice(0, 8);
                        const validTypes = [...SecurityUtils.ALLOWED_IMAGE_TYPES, ...SecurityUtils.ALLOWED_DOC_TYPES];
                        
                        for (const type of validTypes) {
                            const signatures = SecurityUtils.MAGIC_BYTES[type];
                            if (signatures) {
                                for (const sig of signatures) {
                                    let match = true;
                                    for (let i = 0; i < sig.length; i++) {
                                        if (arr[i] !== sig[i]) {
                                            match = false;
                                            break;
                                        }
                                    }
                                    if (match) {
                                        resolve({ valid: true, detectedType: type });
                                        return;
                                    }
                                }
                            }
                        }
                        resolve({ valid: false, detectedType: null });
                    };
                    reader.onerror = () => resolve({ valid: false, detectedType: null });
                    reader.readAsArrayBuffer(file.slice(0, 8));
                });
            },
            
            // üõ°Ô∏è Comprehensive file validation
            validateFile: async (file) => {
                const errors = [];
                
                // Check if file exists
                if (!file) {
                    return { valid: false, errors: ['No file provided'] };
                }
                
                // Check file size
                if (file.size > SecurityUtils.MAX_FILE_SIZE) {
                    errors.push(`File too large. Maximum size is ${SecurityUtils.MAX_FILE_SIZE / 1024 / 1024}MB`);
                }
                
                // Check MIME type
                const allowedTypes = [...SecurityUtils.ALLOWED_IMAGE_TYPES, ...SecurityUtils.ALLOWED_DOC_TYPES];
                if (!allowedTypes.includes(file.type)) {
                    errors.push('File type not allowed. Use JPEG, PNG, GIF, WebP, or PDF');
                }
                
                // Check file extension
                const ext = file.name.split('.').pop().toLowerCase();
                const allowedExtensions = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'pdf'];
                if (!allowedExtensions.includes(ext)) {
                    errors.push('Invalid file extension');
                }
                
                // üõ°Ô∏è Check for double extensions (e.g., malware.php.jpg)
                const nameParts = file.name.split('.');
                if (nameParts.length > 2) {
                    const suspiciousExts = ['php', 'js', 'html', 'htm', 'exe', 'bat', 'cmd', 'sh'];
                    for (let i = 0; i < nameParts.length - 1; i++) {
                        if (suspiciousExts.includes(nameParts[i].toLowerCase())) {
                            errors.push('Suspicious file name detected');
                            break;
                        }
                    }
                }
                
                // üõ°Ô∏è Check for null bytes in filename
                if (file.name.includes('\0') || file.name.includes('%00')) {
                    errors.push('Invalid characters in filename');
                }
                
                // üõ°Ô∏è Verify magic bytes match claimed type
                if (errors.length === 0) {
                    const magicCheck = await SecurityUtils.verifyFileMagicBytes(file);
                    if (!magicCheck.valid) {
                        errors.push('File content does not match file type');
                    }
                }
                
                return { 
                    valid: errors.length === 0, 
                    errors 
                };
            },
            
            // üõ°Ô∏è Generate secure random filename
            generateSecureFilename: (originalName) => {
                const ext = originalName.split('.').pop().toLowerCase();
                const allowedExtensions = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'pdf'];
                const safeExt = allowedExtensions.includes(ext) ? ext : 'bin';
                return `${SecurityUtils.generateUUID()}.${safeExt}`;
            },
            
            // üõ°Ô∏è Rate limiting helper (client-side)
            createRateLimiter: (maxRequests, windowMs) => {
                const requests = [];
                return () => {
                    const now = Date.now();
                    const windowStart = now - windowMs;
                    // Remove old requests
                    while (requests.length > 0 && requests[0] < windowStart) {
                        requests.shift();
                    }
                    if (requests.length >= maxRequests) {
                        return false; // Rate limited
                    }
                    requests.push(now);
                    return true; // Allowed
                };
            }
        };
        
        // üõ°Ô∏è Create rate limiters for different operations
        const rateLimiters = {
            addItem: SecurityUtils.createRateLimiter(10, 60000), // 10 per minute
            addLog: SecurityUtils.createRateLimiter(20, 60000),  // 20 per minute
            fileUpload: SecurityUtils.createRateLimiter(5, 60000) // 5 per minute
        };
        
        // ===========================================
        // üõ°Ô∏è SECURE SUPABASE CLIENT
        // ===========================================
        
        const supabaseClient = window.supabase.createClient(
            'https://spenpcmolydeumtskdqj.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwZW5wY21vbHlkZXVtdHNrZHFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0NTg5ODcsImV4cCI6MjA4NTAzNDk4N30.NE48F2WNqTwPeH9SvdPaeD7f2u4kbY_wYjSu-6xh1-0'
        );

        const USER_ID = 'erik_main_user';

        // ===========================================
        // üõ°Ô∏è SECURE DATABASE OPERATIONS
        // ===========================================
        
        const SecureDB = {
            // üõ°Ô∏è Generic error handler - never expose internal errors
            handleError: (error, operation) => {
                console.error(`[Security Log] ${operation} error:`, error);
                // Return generic message - never expose internal details
                return { 
                    success: false, 
                    error: 'An unexpected error occurred. Please try again.' 
                };
            },
            
            // üõ°Ô∏è Fetch with ownership verification
            fetchUserData: async (table, additionalFilters = {}) => {
                try {
                    let query = supabaseClient
                        .from(table)
                        .select('*')
                        .eq('user_id', USER_ID);
                    
                    // Apply additional filters
                    Object.entries(additionalFilters).forEach(([key, value]) => {
                        query = query.eq(key, value);
                    });
                    
                    const { data, error } = await query;
                    
                    if (error) throw error;
                    return { success: true, data: data || [] };
                } catch (error) {
                    return SecureDB.handleError(error, `fetch ${table}`);
                }
            },
            
            // üõ°Ô∏è Insert with validation
            insertData: async (table, data, allowedFields) => {
                try {
                    // üõ°Ô∏è Whitelist allowed fields to prevent mass assignment
                    const sanitizedData = {};
                    allowedFields.forEach(field => {
                        if (data[field] !== undefined) {
                            sanitizedData[field] = data[field];
                        }
                    });
                    
                    // üõ°Ô∏è Always set user_id server-side concept (we enforce it here)
                    sanitizedData.user_id = USER_ID;
                    
                    const { data: result, error } = await supabaseClient
                        .from(table)
                        .insert([sanitizedData])
                        .select();
                    
                    if (error) throw error;
                    return { success: true, data: result };
                } catch (error) {
                    return SecureDB.handleError(error, `insert ${table}`);
                }
            },
            
            // üõ°Ô∏è Update with ownership check
            updateData: async (table, id, updates, allowedFields) => {
                try {
                    // üõ°Ô∏è Whitelist allowed fields
                    const sanitizedUpdates = {};
                    allowedFields.forEach(field => {
                        if (updates[field] !== undefined) {
                            sanitizedUpdates[field] = updates[field];
                        }
                    });
                    
                    // üõ°Ô∏è Verify ownership before update
                    const { data: existing, error: fetchError } = await supabaseClient
                        .from(table)
                        .select('user_id')
                        .eq('id', id)
                        .single();
                    
                    // üõ°Ô∏è Return 404 (not 403) to prevent enumeration
                    if (fetchError || !existing || existing.user_id !== USER_ID) {
                        return { success: false, error: 'Record not found' };
                    }
                    
                    const { data: result, error } = await supabaseClient
                        .from(table)
                        .update(sanitizedUpdates)
                        .eq('id', id)
                        .eq('user_id', USER_ID) // Double-check ownership
                        .select();
                    
                    if (error) throw error;
                    return { success: true, data: result };
                } catch (error) {
                    return SecureDB.handleError(error, `update ${table}`);
                }
            },
            
            // üõ°Ô∏è Delete with ownership check
            deleteData: async (table, id) => {
                try {
                    // üõ°Ô∏è Verify ownership before delete
                    const { data: existing, error: fetchError } = await supabaseClient
                        .from(table)
                        .select('user_id')
                        .eq('id', id)
                        .single();
                    
                    // üõ°Ô∏è Return 404 (not 403) to prevent enumeration
                    if (fetchError || !existing || existing.user_id !== USER_ID) {
                        return { success: false, error: 'Record not found' };
                    }
                    
                    const { error } = await supabaseClient
                        .from(table)
                        .delete()
                        .eq('id', id)
                        .eq('user_id', USER_ID); // Double-check ownership
                    
                    if (error) throw error;
                    return { success: true };
                } catch (error) {
                    return SecureDB.handleError(error, `delete ${table}`);
                }
            },
            
            // üõ°Ô∏è Secure file upload
            uploadFile: async (file) => {
                try {
                    // üõ°Ô∏è Rate limit check
                    if (!rateLimiters.fileUpload()) {
                        return { success: false, error: 'Too many uploads. Please wait a moment.' };
                    }
                    
                    // üõ°Ô∏è Comprehensive file validation
                    const validation = await SecurityUtils.validateFile(file);
                    if (!validation.valid) {
                        return { success: false, error: validation.errors.join('. ') };
                    }
                    
                    // üõ°Ô∏è Generate secure filename (discard original name)
                    const secureFilename = `${USER_ID}/${SecurityUtils.generateSecureFilename(file.name)}`;
                    
                    const { data, error } = await supabaseClient.storage
                        .from('attachments')
                        .upload(secureFilename, file, {
                            contentType: file.type,
                            upsert: false
                        });
                    
                    if (error) throw error;
                    return { success: true, path: data.path };
                } catch (error) {
                    return SecureDB.handleError(error, 'file upload');
                }
            }
        };

        // Icons (unchanged - these are safe SVG components)
        const Plus = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
        );
        const Car = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><path d="M9 17h6"/><circle cx="17" cy="17" r="2"/></svg>
        );
        const PawPrint = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="4" r="2"/><circle cx="18" cy="8" r="2"/><circle cx="20" cy="16" r="2"/><circle cx="9" cy="10" r="2"/><circle cx="15" cy="14" r="2"/><path d="M9 18a5 5 0 0 1 6 0"/></svg>
        );
        const Home = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        );
        const Bell = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>
        );
        const ArrowLeft = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
        );
        const Trash2 = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
        );
        const Upload = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
        );
        const X = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        );
        const AlertTriangle = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>
        );

        const CATEGORY_CONFIGS = {
            vehicles: {
                name: 'Vehicles',
                icon: Car,
                color: 'blue',
                itemFields: ['year', 'make', 'model', 'current_mileage'],
                logTypes: ['Oil Change', 'Tire Rotation', 'Brake Service', 'Air Filter', 'Transmission Service', 'Coolant Flush', 'Battery Replacement', 'Inspection', 'Other']
            },
            pets: {
                name: 'Pets',
                icon: PawPrint,
                color: 'purple',
                itemFields: ['name', 'type', 'birthdate'],
                logTypes: ['Vet Visit', 'Vaccination', 'Medication', 'Grooming', 'Weight Check', 'Other']
            }
        };

        // üõ°Ô∏è Error Banner Component
        const ErrorBanner = ({ message, onDismiss }) => {
            if (!message) return null;
            return (
                <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4 flex items-center justify-between">
                    <div className="flex items-center gap-2">
                        <AlertTriangle size={20} />
                        <span>{message}</span>
                    </div>
                    <button onClick={onDismiss} className="text-red-500 hover:text-red-700">
                        <X size={18} />
                    </button>
                </div>
            );
        };

        const LifeTracker = () => {
            const [view, setView] = useState('main');
            const [selectedCategory, setSelectedCategory] = useState(null);
            const [categories, setCategories] = useState([]);
            const [items, setItems] = useState([]);
            const [logs, setLogs] = useState([]);
            const [reminders, setReminders] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showQuickAdd, setShowQuickAdd] = useState(false);
            const [error, setError] = useState(null);

            useEffect(() => {
                initializeData();
            }, []);

            const initializeData = async () => {
                setLoading(true);
                setError(null);
                try {
                    const { data: existingCats } = await supabaseClient
                        .from('categories')
                        .select('*')
                        .eq('user_id', USER_ID);

                    if (!existingCats || existingCats.length === 0) {
                        const defaultCategories = [
                            { id: SecurityUtils.generateUUID(), user_id: USER_ID, name: 'Vehicles', icon: 'car' },
                            { id: SecurityUtils.generateUUID(), user_id: USER_ID, name: 'Pets', icon: 'paw' }
                        ];
                        await supabaseClient.from('categories').insert(defaultCategories);
                        await migrateOldData();
                    }

                    await loadAllData();
                } catch (error) {
                    console.error('[Security Log] Initialization error:', error);
                    setError('Failed to load data. Please refresh the page.');
                } finally {
                    setLoading(false);
                }
            };

            const migrateOldData = async () => {
                try {
                    const { data: oldVehicles } = await supabaseClient
                        .from('vehicles')
                        .select('*')
                        .eq('user_id', USER_ID);

                    if (oldVehicles && oldVehicles.length > 0) {
                        const newItems = oldVehicles.map(v => ({
                            id: SecurityUtils.generateUUID(), // üõ°Ô∏è Use UUID instead of old ID
                            user_id: USER_ID,
                            category_id: 'vehicles',
                            name: SecurityUtils.sanitizeString(`${v.year} ${v.make} ${v.model}`, 200),
                            details: {
                                year: SecurityUtils.sanitizeString(String(v.year), 4),
                                make: SecurityUtils.sanitizeString(v.make, 50),
                                model: SecurityUtils.sanitizeString(v.model, 50),
                                current_mileage: v.current_mileage
                            }
                        }));
                        await supabaseClient.from('items').insert(newItems);
                    }
                } catch (error) {
                    console.error('[Security Log] Migration error:', error);
                }
            };

            const loadAllData = async () => {
                const [catsRes, itemsRes, logsRes, remindersRes] = await Promise.all([
                    SecureDB.fetchUserData('categories'),
                    SecureDB.fetchUserData('items'),
                    SecureDB.fetchUserData('logs'),
                    SecureDB.fetchUserData('reminders_v2')
                ]);

                if (catsRes.success) setCategories(catsRes.data);
                if (itemsRes.success) setItems(itemsRes.data);
                if (logsRes.success) setLogs(logsRes.data);
                if (remindersRes.success) setReminders(remindersRes.data);
            };

            const getUpcomingReminders = () => {
                const today = new Date();
                return reminders
                    .map(r => {
                        const item = items.find(i => i.id === r.item_id);
                        if (!item) return null;
                        
                        let dueDate;
                        if (r.reminder_type === 'date') {
                            dueDate = new Date(r.due_date);
                        } else if (r.reminder_type === 'recurring') {
                            dueDate = new Date(r.due_date);
                        }
                        
                        return {
                            ...r,
                            item,
                            dueDate,
                            isOverdue: dueDate < today,
                            daysUntil: Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24))
                        };
                    })
                    .filter(r => r !== null)
                    .sort((a, b) => a.dueDate - b.dueDate)
                    .slice(0, 10);
            };

            if (loading) {
                return (
                    <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                            <p className="text-gray-600">Loading...</p>
                        </div>
                    </div>
                );
            }

            if (view === 'category' && selectedCategory) {
                return (
                    <CategoryView
                        category={selectedCategory}
                        items={items.filter(i => i.category_id === selectedCategory)}
                        logs={logs}
                        reminders={reminders}
                        onBack={() => setView('main')}
                        onRefresh={loadAllData}
                    />
                );
            }

            const upcomingReminders = getUpcomingReminders();

            return (
                <div className="min-h-screen bg-gray-50 pb-20">
                    <div className="max-w-4xl mx-auto p-6">
                        <h1 className="text-4xl font-bold text-gray-900 mb-8">Life Tracker</h1>
                        
                        <ErrorBanner message={error} onDismiss={() => setError(null)} />

                        {upcomingReminders.length > 0 && (
                            <div className="bg-white rounded-lg shadow-sm p-6 mb-6">
                                <div className="flex items-center gap-2 mb-4">
                                    <Bell size={24} className="text-blue-600" />
                                    <h2 className="text-xl font-semibold">Upcoming Reminders</h2>
                                </div>
                                <div className="space-y-3">
                                    {upcomingReminders.map(reminder => (
                                        <div key={reminder.id} className={`p-3 rounded-lg border ${reminder.isOverdue ? 'bg-red-50 border-red-200' : 'bg-blue-50 border-blue-200'}`}>
                                            <div className="flex justify-between items-start">
                                                <div>
                                                    {/* üõ°Ô∏è Escaped output */}
                                                    <p className="font-semibold">{SecurityUtils.escapeHtml(reminder.title)}</p>
                                                    <p className="text-sm text-gray-600">{SecurityUtils.escapeHtml(reminder.item.name)}</p>
                                                </div>
                                                <p className={`text-sm font-medium ${reminder.isOverdue ? 'text-red-600' : 'text-blue-600'}`}>
                                                    {reminder.isOverdue ? 'Overdue' : `${reminder.daysUntil} days`}
                                                </p>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {Object.entries(CATEGORY_CONFIGS).map(([id, config]) => {
                                const Icon = config.icon;
                                const categoryItems = items.filter(i => i.category_id === id);
                                return (
                                    <button
                                        key={id}
                                        onClick={() => {
                                            setSelectedCategory(id);
                                            setView('category');
                                        }}
                                        className="bg-white rounded-lg shadow-sm p-8 hover:shadow-md transition-shadow text-left"
                                    >
                                        <div className="flex items-center gap-4 mb-4">
                                            <div className={`p-3 rounded-lg bg-${config.color}-100`}>
                                                <Icon size={32} className={`text-${config.color}-600`} />
                                            </div>
                                            <div>
                                                <h2 className="text-2xl font-bold text-gray-900">{config.name}</h2>
                                                <p className="text-gray-500">{categoryItems.length} items</p>
                                            </div>
                                        </div>
                                    </button>
                                );
                            })}
                        </div>
                    </div>

                    <button
                        onClick={() => setShowQuickAdd(true)}
                        className="fixed bottom-6 right-6 bg-blue-600 text-white p-4 rounded-full shadow-lg hover:bg-blue-700 transition-colors"
                        aria-label="Quick Add"
                    >
                        <Plus size={32} />
                    </button>

                    {showQuickAdd && (
                        <QuickAddModal
                            onClose={() => setShowQuickAdd(false)}
                            onRefresh={loadAllData}
                            categories={categories}
                            items={items}
                        />
                    )}
                </div>
            );
        };

        const CategoryView = ({ category, items, logs, reminders, onBack, onRefresh }) => {
            const [selectedItem, setSelectedItem] = useState(null);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [showAddItem, setShowAddItem] = useState(false);
            const [showAddLog, setShowAddLog] = useState(false);
            const [error, setError] = useState(null);

            const config = CATEGORY_CONFIGS[category];
            const Icon = config.icon;

            const categoryLogs = logs.filter(l => items.some(i => i.id === l.item_id));
            const categoryReminders = reminders.filter(r => items.some(i => i.id === r.item_id));

            const handleDeleteItem = async (item) => {
                if (!confirm(`Delete ${item.name}? This will also delete all logs and reminders.`)) return;
                
                const result = await SecureDB.deleteData('items', item.id);
                if (result.success) {
                    setSelectedItem(null);
                    onRefresh();
                } else {
                    setError(result.error);
                }
            };

            if (items.length === 0) {
                return (
                    <div className="min-h-screen bg-gray-50">
                        <div className="max-w-4xl mx-auto p-6">
                            <button onClick={onBack} className="flex items-center gap-2 text-gray-600 mb-6 hover:text-gray-900">
                                <ArrowLeft size={20} />
                                Back
                            </button>
                            
                            <ErrorBanner message={error} onDismiss={() => setError(null)} />
                            
                            <div className="bg-white rounded-lg shadow-sm p-12 text-center">
                                <Icon size={64} className="mx-auto text-gray-400 mb-4" />
                                <h2 className="text-2xl font-semibold text-gray-700 mb-2">No {config.name} Yet</h2>
                                <p className="text-gray-500 mb-6">Add your first {config.name.toLowerCase()} to get started</p>
                                <button
                                    onClick={() => setShowAddItem(true)}
                                    className="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700"
                                >
                                    Add {config.name}
                                </button>
                            </div>
                        </div>

                        {showAddItem && (
                            <AddItemModal
                                category={category}
                                onClose={() => setShowAddItem(false)}
                                onRefresh={onRefresh}
                            />
                        )}
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50">
                    <div className="max-w-6xl mx-auto p-6">
                        <button onClick={onBack} className="flex items-center gap-2 text-gray-600 mb-6 hover:text-gray-900">
                            <ArrowLeft size={20} />
                            Back to Dashboard
                        </button>
                        
                        <ErrorBanner message={error} onDismiss={() => setError(null)} />

                        <div className="bg-white rounded-lg shadow-sm p-6 mb-6">
                            <div className="flex items-center justify-between mb-4">
                                <h1 className="text-3xl font-bold text-gray-900">{config.name}</h1>
                                <button
                                    onClick={() => setShowAddItem(true)}
                                    className="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
                                >
                                    <Plus size={20} />
                                    Add {config.name}
                                </button>
                            </div>

                            <div className="flex gap-2 overflow-x-auto pb-2">
                                {items.map(item => (
                                    <div key={item.id} className="relative group">
                                        <button
                                            onClick={() => setSelectedItem(item.id)}
                                            className={`px-4 py-2 rounded-lg whitespace-nowrap ${
                                                selectedItem === item.id
                                                    ? `bg-${config.color}-600 text-white`
                                                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                            }`}
                                        >
                                            {/* üõ°Ô∏è Escaped output */}
                                            {SecurityUtils.escapeHtml(item.name)}
                                        </button>
                                        {selectedItem === item.id && (
                                            <button
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    handleDeleteItem(item);
                                                }}
                                                className="absolute -top-2 -right-2 bg-red-600 text-white rounded-full p-1 hover:bg-red-700 shadow-lg"
                                                aria-label="Delete item"
                                            >
                                                <X size={14} />
                                            </button>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>

                        {selectedItem && (
                            <>
                                <div className="flex gap-2 mb-6">
                                    <button
                                        onClick={() => setActiveTab('dashboard')}
                                        className={`px-4 py-2 rounded-lg ${activeTab === 'dashboard' ? 'bg-white shadow-sm' : 'hover:bg-white/50'}`}
                                    >
                                        Dashboard
                                    </button>
                                    <button
                                        onClick={() => setActiveTab('history')}
                                        className={`px-4 py-2 rounded-lg ${activeTab === 'history' ? 'bg-white shadow-sm' : 'hover:bg-white/50'}`}
                                    >
                                        History
                                    </button>
                                    <button
                                        onClick={() => setActiveTab('reminders')}
                                        className={`px-4 py-2 rounded-lg ${activeTab === 'reminders' ? 'bg-white shadow-sm' : 'hover:bg-white/50'}`}
                                    >
                                        Reminders
                                    </button>
                                </div>

                                {activeTab === 'dashboard' && (
                                    <DashboardTab
                                        item={items.find(i => i.id === selectedItem)}
                                        logs={categoryLogs.filter(l => l.item_id === selectedItem)}
                                        onAddLog={() => setShowAddLog(true)}
                                        onRefresh={onRefresh}
                                    />
                                )}

                                {activeTab === 'history' && (
                                    <HistoryTab
                                        logs={categoryLogs.filter(l => l.item_id === selectedItem)}
                                        onRefresh={onRefresh}
                                    />
                                )}

                                {activeTab === 'reminders' && (
                                    <RemindersTab
                                        reminders={categoryReminders.filter(r => r.item_id === selectedItem)}
                                        itemId={selectedItem}
                                        onRefresh={onRefresh}
                                    />
                                )}
                            </>
                        )}
                    </div>

                    {showAddItem && (
                        <AddItemModal
                            category={category}
                            onClose={() => setShowAddItem(false)}
                            onRefresh={() => {
                                onRefresh();
                                setShowAddItem(false);
                            }}
                        />
                    )}

                    {showAddLog && selectedItem && (
                        <AddLogModal
                            category={category}
                            itemId={selectedItem}
                            onClose={() => setShowAddLog(false)}
                            onRefresh={() => {
                                onRefresh();
                                setShowAddLog(false);
                            }}
                        />
                    )}
                </div>
            );
        };

        const DashboardTab = ({ item, logs, onAddLog, onRefresh }) => {
            const [notes, setNotes] = useState(item.details?.notes || '');
            const [isSavingNotes, setIsSavingNotes] = useState(false);
            const [error, setError] = useState(null);

            const totalCost = logs.reduce((sum, l) => sum + parseFloat(l.cost || 0), 0);
            const lastLog = logs.length > 0 ? logs.sort((a, b) => new Date(b.date) - new Date(a.date))[0] : null;

            const saveNotes = async () => {
                setIsSavingNotes(true);
                setError(null);
                
                // üõ°Ô∏è Sanitize notes input
                const sanitizedNotes = SecurityUtils.sanitizeString(notes, 5000);
                const updatedDetails = { ...item.details, notes: sanitizedNotes };
                
                const result = await SecureDB.updateData(
                    'items', 
                    item.id, 
                    { details: updatedDetails },
                    ['details'] // üõ°Ô∏è Whitelist only the details field
                );
                
                if (!result.success) {
                    setError(result.error);
                }
                setIsSavingNotes(false);
            };

            return (
                <div className="space-y-6">
                    <ErrorBanner message={error} onDismiss={() => setError(null)} />
                    
                    {/* Item Details */}
                    <div className="bg-white rounded-lg shadow-sm p-6">
                        <h3 className="font-semibold text-gray-700 mb-4">Item Details</h3>
                        <div className="grid grid-cols-2 gap-4 text-sm">
                            {Object.entries(item.details || {}).map(([key, value]) => {
                                if (key === 'notes') return null;
                                return (
                                    <div key={key}>
                                        <span className="text-gray-600 capitalize">{key.replace(/_/g, ' ')}:</span>
                                        {/* üõ°Ô∏è Escaped output */}
                                        <span className="ml-2 font-medium">{SecurityUtils.escapeHtml(String(value))}</span>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {/* Stats */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div className="bg-white rounded-lg shadow-sm p-6">
                            <h3 className="font-semibold text-gray-700 mb-2">Total Logs</h3>
                            <p className="text-3xl font-bold text-gray-900">{logs.length}</p>
                        </div>
                        <div className="bg-white rounded-lg shadow-sm p-6">
                            <h3 className="font-semibold text-gray-700 mb-2">Total Spent</h3>
                            <p className="text-3xl font-bold text-gray-900">${totalCost.toFixed(2)}</p>
                        </div>
                        <div className="bg-white rounded-lg shadow-sm p-6">
                            <h3 className="font-semibold text-gray-700 mb-2">Last Log</h3>
                            <p className="text-lg font-bold text-gray-900">
                                {lastLog ? new Date(lastLog.date).toLocaleDateString() : 'None'}
                            </p>
                        </div>
                    </div>

                    {/* Notes */}
                    <div className="bg-white rounded-lg shadow-sm p-6">
                        <h3 className="font-semibold text-gray-700 mb-4">Notes</h3>
                        <textarea
                            value={notes}
                            onChange={(e) => setNotes(e.target.value)}
                            onBlur={saveNotes}
                            placeholder="Add notes about this item..."
                            className="w-full px-4 py-2 border rounded-lg"
                            rows="4"
                            maxLength={5000}
                        />
                        {isSavingNotes && <p className="text-sm text-gray-500 mt-2">Saving...</p>}
                    </div>

                    {/* Quick Actions */}
                    <div className="bg-white rounded-lg shadow-sm p-6">
                        <h3 className="font-semibold text-gray-700 mb-4">Quick Actions</h3>
                        <button
                            onClick={onAddLog}
                            className="w-full bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700"
                        >
                            Add New Log
                        </button>
                    </div>
                </div>
            );
        };

        const HistoryTab = ({ logs, onRefresh }) => {
            const [editingLog, setEditingLog] = useState(null);
            const [error, setError] = useState(null);

            const deleteLog = async (id) => {
                if (!confirm('Delete this log?')) return;
                const result = await SecureDB.deleteData('logs', id);
                if (result.success) {
                    onRefresh();
                } else {
                    setError(result.error);
                }
            };

            const sortedLogs = [...logs].sort((a, b) => new Date(b.date) - new Date(a.date));

            return (
                <div className="bg-white rounded-lg shadow-sm p-6">
                    <h2 className="text-xl font-semibold mb-6">History</h2>
                    
                    <ErrorBanner message={error} onDismiss={() => setError(null)} />
                    
                    <div className="space-y-4">
                        {sortedLogs.map(log => (
                            <div key={log.id} className="border rounded-lg p-4 hover:bg-gray-50">
                                <div className="flex justify-between items-start mb-2">
                                    <div>
                                        {/* üõ°Ô∏è Escaped output */}
                                        <h3 className="font-semibold text-lg">{SecurityUtils.escapeHtml(log.log_type)}</h3>
                                        <p className="text-gray-600">{new Date(log.date).toLocaleDateString()}</p>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        {log.cost && <span className="font-medium">${parseFloat(log.cost).toFixed(2)}</span>}
                                        <button 
                                            onClick={() => setEditingLog(log)} 
                                            className="text-blue-600 hover:text-blue-700"
                                            aria-label="Edit log"
                                        >
                                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                                <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>
                                            </svg>
                                        </button>
                                        <button onClick={() => deleteLog(log.id)} className="text-red-600 hover:text-red-700" aria-label="Delete log">
                                            <Trash2 size={18} />
                                        </button>
                                    </div>
                                </div>
                                {/* üõ°Ô∏è Escaped output */}
                                {log.notes && <p className="text-sm text-gray-700 mt-2">{SecurityUtils.escapeHtml(log.notes)}</p>}
                            </div>
                        ))}
                        {sortedLogs.length === 0 && (
                            <div className="text-center py-12 text-gray-500">
                                No logs yet. Add your first one!
                            </div>
                        )}
                    </div>

                    {editingLog && (
                        <EditLogModal
                            log={editingLog}
                            onClose={() => setEditingLog(null)}
                            onRefresh={() => {
                                onRefresh();
                                setEditingLog(null);
                            }}
                        />
                    )}
                </div>
            );
        };

        const RemindersTab = ({ reminders, itemId, onRefresh }) => {
            const [showAddReminder, setShowAddReminder] = useState(false);
            const [error, setError] = useState(null);

            const deleteReminder = async (id) => {
                if (!confirm('Delete this reminder?')) return;
                const result = await SecureDB.deleteData('reminders_v2', id);
                if (result.success) {
                    onRefresh();
                } else {
                    setError(result.error);
                }
            };

            return (
                <div className="bg-white rounded-lg shadow-sm p-6">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl font-semibold">Reminders</h2>
                        <button
                            onClick={() => setShowAddReminder(true)}
                            className="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
                        >
                            <Plus size={18} />
                            Add Reminder
                        </button>
                    </div>
                    
                    <ErrorBanner message={error} onDismiss={() => setError(null)} />
                    
                    <div className="space-y-4">
                        {reminders.map(reminder => (
                            <div key={reminder.id} className="border rounded-lg p-4 hover:bg-gray-50">
                                <div className="flex justify-between items-start">
                                    <div>
                                        {/* üõ°Ô∏è Escaped output */}
                                        <h3 className="font-semibold text-lg">{SecurityUtils.escapeHtml(reminder.title)}</h3>
                                        <p className="text-gray-600">
                                            {reminder.reminder_type === 'date' 
                                                ? `Due: ${new Date(reminder.due_date).toLocaleDateString()}`
                                                : `Recurring: ${SecurityUtils.escapeHtml(reminder.recurrence || '')}`
                                            }
                                        </p>
                                    </div>
                                    <button onClick={() => deleteReminder(reminder.id)} className="text-red-600 hover:text-red-700" aria-label="Delete reminder">
                                        <Trash2 size={18} />
                                    </button>
                                </div>
                            </div>
                        ))}
                        {reminders.length === 0 && (
                            <div className="text-center py-12 text-gray-500">
                                No reminders set. Add one to stay on track!
                            </div>
                        )}
                    </div>
                    
                    {showAddReminder && (
                        <AddReminderModal
                            itemId={itemId}
                            onClose={() => setShowAddReminder(false)}
                            onRefresh={() => {
                                onRefresh();
                                setShowAddReminder(false);
                            }}
                        />
                    )}
                </div>
            );
        };

        // üõ°Ô∏è New: Add Reminder Modal
        const AddReminderModal = ({ itemId, onClose, onRefresh }) => {
            const [formData, setFormData] = useState({
                title: '',
                reminderType: 'date',
                dueDate: '',
                recurrence: 'monthly'
            });
            const [error, setError] = useState(null);
            const [isSubmitting, setIsSubmitting] = useState(false);

            const handleSubmit = async () => {
                setError(null);
                
                // üõ°Ô∏è Validation
                if (!formData.title.trim()) {
                    setError('Title is required');
                    return;
                }
                
                if (formData.reminderType === 'date' && !SecurityUtils.isValidDate(formData.dueDate)) {
                    setError('Please enter a valid date');
                    return;
                }
                
                setIsSubmitting(true);
                
                const newReminder = {
                    id: SecurityUtils.generateUUID(),
                    item_id: itemId,
                    user_id: USER_ID,
                    title: SecurityUtils.sanitizeString(formData.title, 200),
                    reminder_type: formData.reminderType,
                    due_date: formData.dueDate || new Date().toISOString().split('T')[0],
                    recurrence: formData.reminderType === 'recurring' ? formData.recurrence : null
                };

                const result = await SecureDB.insertData(
                    'reminders_v2',
                    newReminder,
                    ['id', 'item_id', 'user_id', 'title', 'reminder_type', 'due_date', 'recurrence']
                );
                
                setIsSubmitting(false);
                
                if (result.success) {
                    onRefresh();
                } else {
                    setError(result.error);
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-lg p-6 max-w-md w-full">
                        <h2 className="text-2xl font-bold mb-4">Add Reminder</h2>
                        
                        <ErrorBanner message={error} onDismiss={() => setError(null)} />
                        
                        <div className="space-y-4">
                            <input
                                type="text"
                                placeholder="Reminder title"
                                value={formData.title}
                                onChange={(e) => setFormData({ ...formData, title: e.target.value })}
                                className="w-full px-4 py-2 border rounded-lg"
                                maxLength={200}
                            />
                            
                            <select
                                value={formData.reminderType}
                                onChange={(e) => setFormData({ ...formData, reminderType: e.target.value })}
                                className="w-full px-4 py-2 border rounded-lg"
                            >
                                <option value="date">One-time (specific date)</option>
                                <option value="recurring">Recurring</option>
                            </select>
                            
                            <input
                                type="date"
                                value={formData.dueDate}
                                onChange={(e) => setFormData({ ...formData, dueDate: e.target.value })}
                                className="w-full px-4 py-2 border rounded-lg"
                            />
                            
                            {formData.reminderType === 'recurring' && (
                                <select
                                    value={formData.recurrence}
                                    onChange={(e) => setFormData({ ...formData, recurrence: e.target.value })}
                                    className="w-full px-4 py-2 border rounded-lg"
                                >
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                    <option value="yearly">Yearly</option>
                                </select>
                            )}
                        </div>
                        
                        <div className="flex gap-3 mt-6">
                            <button
                                onClick={handleSubmit}
                                disabled={isSubmitting}
                                className="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 disabled:bg-gray-400"
                            >
                                {isSubmitting ? 'Adding...' : 'Add Reminder'}
                            </button>
                            <button
                                onClick={onClose}
                                className="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300"
                            >
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const QuickAddModal = ({ onClose, onRefresh, categories, items }) => {
            const [formData, setFormData] = useState({
                category: '',
                itemId: '',
                logType: '',
                date: new Date().toISOString().split('T')[0],
                cost: '',
                notes: '',
                file: null
            });
            const [error, setError] = useState(null);
            const [isSubmitting, setIsSubmitting] = useState(false);

            const handleSubmit = async () => {
                setError(null);
                
                // üõ°Ô∏è Rate limit check
                if (!rateLimiters.addLog()) {
                    setError('Too many requests. Please wait a moment.');
                    return;
                }
                
                // üõ°Ô∏è Validation
                if (!formData.itemId || !formData.logType) {
                    setError('Please select an item and log type');
                    return;
                }
                
                if (!SecurityUtils.isValidDate(formData.date)) {
                    setError('Please enter a valid date');
                    return;
                }
                
                if (formData.cost && !SecurityUtils.isValidPositiveNumber(formData.cost)) {
                    setError('Please enter a valid cost');
                    return;
                }
                
                setIsSubmitting(true);

                const newLog = {
                    id: SecurityUtils.generateUUID(),
                    item_id: formData.itemId,
                    user_id: USER_ID,
                    log_type: SecurityUtils.sanitizeString(formData.logType, 100),
                    date: formData.date,
                    cost: formData.cost ? parseFloat(formData.cost) : null,
                    notes: SecurityUtils.sanitizeString(formData.notes, 2000)
                };

                const result = await SecureDB.insertData(
                    'logs',
                    newLog,
                    ['id', 'item_id', 'user_id', 'log_type', 'date', 'cost', 'notes']
                );
                
                if (!result.success) {
                    setError(result.error);
                    setIsSubmitting(false);
                    return;
                }
                
                // üõ°Ô∏è Secure file upload
                if (formData.file) {
                    const uploadResult = await SecureDB.uploadFile(formData.file);
                    if (!uploadResult.success) {
                        // Log was saved but file upload failed - notify user
                        setError(`Log saved, but file upload failed: ${uploadResult.error}`);
                        setIsSubmitting(false);
                        onRefresh();
                        return;
                    }
                }

                setIsSubmitting(false);
                onRefresh();
                onClose();
            };

            const config = formData.category ? CATEGORY_CONFIGS[formData.category] : null;
            const categoryItems = formData.category ? items.filter(i => i.category_id === formData.category) : [];

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-lg p-6 max-w-md w-full max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold">Quick Add</h2>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-700" aria-label="Close">
                                <X size={24} />
                            </button>
                        </div>
                        
                        <ErrorBanner message={error} onDismiss={() => setError(null)} />

                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium mb-2">Category</label>
                                <select
                                    value={formData.category}
                                    onChange={(e) => setFormData({ ...formData, category: e.target.value, itemId: '' })}
                                    className="w-full px-4 py-2 border rounded-lg"
                                >
                                    <option value="">Select category...</option>
                                    {Object.entries(CATEGORY_CONFIGS).map(([id, config]) => (
                                        <option key={id} value={id}>{config.name}</option>
                                    ))}
                                </select>
                            </div>

                            {formData.category && (
                                <div>
                                    <label className="block text-sm font-medium mb-2">Item</label>
                                    <select
                                        value={formData.itemId}
                                        onChange={(e) => setFormData({ ...formData, itemId: e.target.value })}
                                        className="w-full px-4 py-2 border rounded-lg"
                                    >
                                        <option value="">Select item...</option>
                                        {categoryItems.map(item => (
                                            <option key={item.id} value={item.id}>{item.name}</option>
                                        ))}
                                    </select>
                                </div>
                            )}

                            {formData.itemId && config && (
                                <div>
                                    <label className="block text-sm font-medium mb-2">Log Type</label>
                                    <select
                                        value={formData.logType}
                                        onChange={(e) => setFormData({ ...formData, logType: e.target.value })}
                                        className="w-full px-4 py-2 border rounded-lg"
                                    >
                                        <option value="">Select type...</option>
                                        {config.logTypes.map(type => (
                                            <option key={type} value={type}>{type}</option>
                                        ))}
                                    </select>
                                </div>
                            )}

                            {formData.logType && (
                                <>
                                    <input
                                        type="date"
                                        value={formData.date}
                                        onChange={(e) => setFormData({ ...formData, date: e.target.value })}
                                        className="w-full px-4 py-2 border rounded-lg"
                                    />
                                    <input
                                        type="number"
                                        step="0.01"
                                        min="0"
                                        max="9999999"
                                        placeholder="Cost ($) - optional"
                                        value={formData.cost}
                                        onChange={(e) => setFormData({ ...formData, cost: e.target.value })}
                                        className="w-full px-4 py-2 border rounded-lg"
                                    />
                                    <textarea
                                        placeholder="Notes - optional"
                                        value={formData.notes}
                                        onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                                        className="w-full px-4 py-2 border rounded-lg"
                                        rows="3"
                                        maxLength={2000}
                                    />
                                    <div>
                                        <label className="block text-sm font-medium mb-2">Attachment (optional)</label>
                                        <input
                                            type="file"
                                            accept="image/jpeg,image/png,image/gif,image/webp,.pdf"
                                            onChange={(e) => setFormData({ ...formData, file: e.target.files[0] })}
                                            className="w-full px-4 py-2 border rounded-lg"
                                        />
                                        <p className="text-xs text-gray-500 mt-1">Max 10MB. JPEG, PNG, GIF, WebP, or PDF only.</p>
                                    </div>
                                </>
                            )}
                        </div>

                        <div className="flex gap-3 mt-6">
                            <button
                                onClick={handleSubmit}
                                disabled={!formData.itemId || !formData.logType || isSubmitting}
                                className="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
                            >
                                {isSubmitting ? 'Adding...' : 'Add Log'}
                            </button>
                            <button
                                onClick={onClose}
                                className="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300"
                            >
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const AddItemModal = ({ category, onClose, onRefresh }) => {
            const config = CATEGORY_CONFIGS[category];
            const [formData, setFormData] = useState({});
            const [photoFile, setPhotoFile] = useState(null);
            const [error, setError] = useState(null);
            const [isSubmitting, setIsSubmitting] = useState(false);

            const handleSubmit = async () => {
                setError(null);
                
                // üõ°Ô∏è Rate limit check
                if (!rateLimiters.addItem()) {
                    setError('Too many requests. Please wait a moment.');
                    return;
                }
                
                // üõ°Ô∏è Validation based on category
                if (category === 'vehicles') {
                    if (!SecurityUtils.isValidYear(formData.year)) {
                        setError('Please enter a valid year (1900-present)');
                        return;
                    }
                    if (!formData.make?.trim() || !formData.model?.trim()) {
                        setError('Make and model are required');
                        return;
                    }
                    if (formData.current_mileage && !SecurityUtils.isValidMileage(formData.current_mileage)) {
                        setError('Please enter a valid mileage');
                        return;
                    }
                }
                
                if (category === 'pets') {
                    if (!formData.name?.trim()) {
                        setError('Pet name is required');
                        return;
                    }
                    if (formData.birthdate && !SecurityUtils.isValidDate(formData.birthdate)) {
                        setError('Please enter a valid birthdate');
                        return;
                    }
                }
                
                setIsSubmitting(true);

                const newItem = {
                    id: SecurityUtils.generateUUID(),
                    user_id: USER_ID,
                    category_id: category,
                    name: category === 'vehicles' 
                        ? SecurityUtils.sanitizeString(`${formData.year} ${formData.make} ${formData.model}`, 200)
                        : SecurityUtils.sanitizeString(formData.name, 200),
                    details: {
                        ...Object.fromEntries(
                            Object.entries(formData).map(([k, v]) => [k, SecurityUtils.sanitizeString(String(v), 200)])
                        )
                    }
                };

                const result = await SecureDB.insertData(
                    'items',
                    newItem,
                    ['id', 'user_id', 'category_id', 'name', 'details']
                );
                
                if (!result.success) {
                    setError(result.error);
                    setIsSubmitting(false);
                    return;
                }

                // üõ°Ô∏è Secure photo upload
                if (photoFile) {
                    const uploadResult = await SecureDB.uploadFile(photoFile);
                    if (!uploadResult.success) {
                        setError(`Item saved, but photo upload failed: ${uploadResult.error}`);
                        setIsSubmitting(false);
                        onRefresh();
                        return;
                    }
                }

                setIsSubmitting(false);
                onRefresh();
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-lg p-6 max-w-md w-full max-h-[90vh] overflow-y-auto">
                        <h2 className="text-2xl font-bold mb-4">Add {config.name}</h2>
                        
                        <ErrorBanner message={error} onDismiss={() => setError(null)} />
                        
                        <div className="space-y-4">
                            {category === 'vehicles' && (
                                <>
                                    <input
                                        type="number"
                                        placeholder="Year"
                                        min="1900"
                                        max={new Date().getFullYear() + 2}
                                        onChange={(e) => setFormData({ ...formData, year: e.target.value })}
                                        className="w-full px-4 py-2 border rounded-lg"
                                    />
                                    <input
                                        type="text"
                                        placeholder="Make"
                                        maxLength={50}
                                        onChange={(e) => setFormData({ ...formData, make: e.target.value })}
                                        className="w-full px-4 py-2 border rounded-lg"
                                    />
                                    <input
                                        type="text"
                                        placeholder="Model"
                                        maxLength={50}
                                        onChange={(e) => setFormData({ ...formData, model: e.target.value })}
                                        className="w-full px-4 py-2 border rounded-lg"
                                    />
                                    <input
                                        type="number"
                                        placeholder="Current Mileage"
                                        min="0"
                                        max="2000000"
                                        onChange={(e) => setFormData({ ...formData, current_mileage: e.target.value })}
                                        className="w-full px-4 py-2 border rounded-lg"
                                    />
                                </>
                            )}
                            {category === 'pets' && (
                                <>
                                    <input
                                        type="text"
                                        placeholder="Name"
                                        maxLength={100}
                                        onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                                        className="w-full px-4 py-2 border rounded-lg"
                                    />
                                    <input
                                        type="text"
                                        placeholder="Type (e.g., Dog, Cat)"
                                        maxLength={50}
                                        onChange={(e) => setFormData({ ...formData, type: e.target.value })}
                                        className="w-full px-4 py-2 border rounded-lg"
                                    />
                                    <input
                                        type="date"
                                        placeholder="Birthdate"
                                        onChange={(e) => setFormData({ ...formData, birthdate: e.target.value })}
                                        className="w-full px-4 py-2 border rounded-lg"
                                    />
                                </>
                            )}
                            <div>
                                <label className="block text-sm font-medium mb-2">Photo (optional)</label>
                                <input
                                    type="file"
                                    accept="image/jpeg,image/png,image/gif,image/webp"
                                    onChange={(e) => setPhotoFile(e.target.files[0])}
                                    className="w-full px-4 py-2 border rounded-lg"
                                />
                                <p className="text-xs text-gray-500 mt-1">Max 10MB. JPEG, PNG, GIF, or WebP only.</p>
                            </div>
                        </div>
                        <div className="flex gap-3 mt-6">
                            <button
                                onClick={handleSubmit}
                                disabled={isSubmitting}
                                className="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 disabled:bg-gray-400"
                            >
                                {isSubmitting ? 'Adding...' : 'Add'}
                            </button>
                            <button
                                onClick={onClose}
                                className="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300"
                            >
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const AddLogModal = ({ category, itemId, onClose, onRefresh }) => {
            const config = CATEGORY_CONFIGS[category];
            const [formData, setFormData] = useState({
                logType: '',
                date: new Date().toISOString().split('T')[0],
                cost: '',
                notes: ''
            });
            const [file, setFile] = useState(null);
            const [error, setError] = useState(null);
            const [isSubmitting, setIsSubmitting] = useState(false);

            const handleSubmit = async () => {
                setError(null);
                
                // üõ°Ô∏è Rate limit check
                if (!rateLimiters.addLog()) {
                    setError('Too many requests. Please wait a moment.');
                    return;
                }
                
                // üõ°Ô∏è Validation
                if (!formData.logType) {
                    setError('Please select a log type');
                    return;
                }
                
                if (!SecurityUtils.isValidDate(formData.date)) {
                    setError('Please enter a valid date');
                    return;
                }
                
                if (formData.cost && !SecurityUtils.isValidPositiveNumber(formData.cost)) {
                    setError('Please enter a valid cost');
                    return;
                }
                
                setIsSubmitting(true);

                const newLog = {
                    id: SecurityUtils.generateUUID(),
                    item_id: itemId,
                    user_id: USER_ID,
                    log_type: SecurityUtils.sanitizeString(formData.logType, 100),
                    date: formData.date,
                    cost: formData.cost ? parseFloat(formData.cost) : null,
                    notes: SecurityUtils.sanitizeString(formData.notes, 2000)
                };

                const result = await SecureDB.insertData(
                    'logs',
                    newLog,
                    ['id', 'item_id', 'user_id', 'log_type', 'date', 'cost', 'notes']
                );
                
                if (!result.success) {
                    setError(result.error);
                    setIsSubmitting(false);
                    return;
                }

                // üõ°Ô∏è Secure file upload
                if (file) {
                    const uploadResult = await SecureDB.uploadFile(file);
                    if (!uploadResult.success) {
                        setError(`Log saved, but file upload failed: ${uploadResult.error}`);
                        setIsSubmitting(false);
                        onRefresh();
                        return;
                    }
                }

                setIsSubmitting(false);
                onRefresh();
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-lg p-6 max-w-md w-full max-h-[90vh] overflow-y-auto">
                        <h2 className="text-2xl font-bold mb-4">Add Log</h2>
                        
                        <ErrorBanner message={error} onDismiss={() => setError(null)} />
                        
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium mb-2">Log Type</label>
                                <select
                                    value={formData.logType}
                                    onChange={(e) => setFormData({ ...formData, logType: e.target.value })}
                                    className="w-full px-4 py-2 border rounded-lg"
                                >
                                    <option value="">Select type...</option>
                                    {config.logTypes.map(type => (
                                        <option key={type} value={type}>{type}</option>
                                    ))}
                                </select>
                            </div>
                            <input
                                type="date"
                                value={formData.date}
                                onChange={(e) => setFormData({ ...formData, date: e.target.value })}
                                className="w-full px-4 py-2 border rounded-lg"
                            />
                            <input
                                type="number"
                                step="0.01"
                                min="0"
                                max="9999999"
                                placeholder="Cost ($) - optional"
                                value={formData.cost}
                                onChange={(e) => setFormData({ ...formData, cost: e.target.value })}
                                className="w-full px-4 py-2 border rounded-lg"
                            />
                            <textarea
                                placeholder="Notes - optional"
                                value={formData.notes}
                                onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                                className="w-full px-4 py-2 border rounded-lg"
                                rows="3"
                                maxLength={2000}
                            />
                            <div>
                                <label className="block text-sm font-medium mb-2">Attachment (optional)</label>
                                <input
                                    type="file"
                                    accept="image/jpeg,image/png,image/gif,image/webp,.pdf"
                                    onChange={(e) => setFile(e.target.files[0])}
                                    className="w-full px-4 py-2 border rounded-lg"
                                />
                                <p className="text-xs text-gray-500 mt-1">Max 10MB. JPEG, PNG, GIF, WebP, or PDF only.</p>
                            </div>
                        </div>
                        <div className="flex gap-3 mt-6">
                            <button
                                onClick={handleSubmit}
                                disabled={isSubmitting}
                                className="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 disabled:bg-gray-400"
                            >
                                {isSubmitting ? 'Adding...' : 'Add Log'}
                            </button>
                            <button
                                onClick={onClose}
                                className="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300"
                            >
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const EditLogModal = ({ log, onClose, onRefresh }) => {
            const [formData, setFormData] = useState({
                logType: log.log_type,
                date: log.date,
                cost: log.cost || '',
                notes: log.notes || ''
            });
            const [error, setError] = useState(null);
            const [isSubmitting, setIsSubmitting] = useState(false);

            const handleSubmit = async () => {
                setError(null);
                
                // üõ°Ô∏è Validation
                if (!formData.logType.trim()) {
                    setError('Log type is required');
                    return;
                }
                
                if (!SecurityUtils.isValidDate(formData.date)) {
                    setError('Please enter a valid date');
                    return;
                }
                
                if (formData.cost && !SecurityUtils.isValidPositiveNumber(formData.cost)) {
                    setError('Please enter a valid cost');
                    return;
                }
                
                setIsSubmitting(true);

                const updatedLog = {
                    log_type: SecurityUtils.sanitizeString(formData.logType, 100),
                    date: formData.date,
                    cost: formData.cost ? parseFloat(formData.cost) : null,
                    notes: SecurityUtils.sanitizeString(formData.notes, 2000)
                };

                const result = await SecureDB.updateData(
                    'logs',
                    log.id,
                    updatedLog,
                    ['log_type', 'date', 'cost', 'notes'] // üõ°Ô∏è Whitelist allowed fields
                );
                
                setIsSubmitting(false);
                
                if (result.success) {
                    onRefresh();
                } else {
                    setError(result.error);
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-lg p-6 max-w-md w-full max-h-[90vh] overflow-y-auto">
                        <h2 className="text-2xl font-bold mb-4">Edit Log</h2>
                        
                        <ErrorBanner message={error} onDismiss={() => setError(null)} />
                        
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium mb-2">Log Type</label>
                                <input
                                    type="text"
                                    value={formData.logType}
                                    onChange={(e) => setFormData({ ...formData, logType: e.target.value })}
                                    className="w-full px-4 py-2 border rounded-lg"
                                    maxLength={100}
                                />
                            </div>
                            <input
                                type="date"
                                value={formData.date}
                                onChange={(e) => setFormData({ ...formData, date: e.target.value })}
                                className="w-full px-4 py-2 border rounded-lg"
                            />
                            <input
                                type="number"
                                step="0.01"
                                min="0"
                                max="9999999"
                                placeholder="Cost ($) - optional"
                                value={formData.cost}
                                onChange={(e) => setFormData({ ...formData, cost: e.target.value })}
                                className="w-full px-4 py-2 border rounded-lg"
                            />
                            <textarea
                                placeholder="Notes - optional"
                                value={formData.notes}
                                onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                                className="w-full px-4 py-2 border rounded-lg"
                                rows="3"
                                maxLength={2000}
                            />
                        </div>
                        <div className="flex gap-3 mt-6">
                            <button
                                onClick={handleSubmit}
                                disabled={isSubmitting}
                                className="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 disabled:bg-gray-400"
                            >
                                {isSubmitting ? 'Saving...' : 'Save Changes'}
                            </button>
                            <button
                                onClick={onClose}
                                className="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300"
                            >
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<LifeTracker />, document.getElementById('root'));
    </script>
</body>
</html>
